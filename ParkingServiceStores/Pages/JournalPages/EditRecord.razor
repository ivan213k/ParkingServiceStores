@page "/EditRecord/{Id:int}";
@inject NavigationManager NavigationManager;
@inject ApplicationDbContext dbContext;
@inject IJSRuntime js;
<AuthorizeView>
    <Authorized>
        <h3>Edit Information About Record</h3>

        @if (cars == null)
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            <div class="text-left">
                <form method="post" @onsubmit="OnFormSubmit">
                    <div class="form-group">
                        <label for="inputCar">Select car:</label>
                        <select tabindex="1" id="inputCar" @bind="record.CarId" class="custom-select">
                            @foreach (var car in cars)
                            {
                                <option value="@car.Id">@car.ToString()</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inputEntryTime">Entry time</label>
                        <SfDateTimePicker class="form-control" TValue="DateTime" @bind-Value="record.EntryTime" Locale="ru"></SfDateTimePicker>
                    </div>
                    <div class="form-group">
                        <label for="inputOwnerPhone">Leaving time</label>
                        <SfDateTimePicker class="form-control" TValue="DateTime" @bind-Value="record.LeavingTime" Locale="ru"></SfDateTimePicker>
                    </div>

                    <button class="btn btn-primary">Save</button>
                </form>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <NotAuthorizedMessage/>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public int Id { get; set; }

    List<Car> cars;

    JournalRecord record;

    protected override async Task OnInitializedAsync()
    {
        cars = await dbContext.Cars.Include(r => r.Owner).ToListAsync();
        record = await dbContext.Journal.SingleAsync(r => r.Id == Id);

    }

    private async void OnFormSubmit()
    {
        if (record.LeavingTime <= record.EntryTime)
        {
            await js.InvokeVoidAsync("alert", "Leaving time can not be less then Entry time!");
            return;
        }
        dbContext.Journal.Update(record);
        await dbContext.SaveChangesAsync();
        NavigationManager.NavigateTo("/journal");
    }

}
